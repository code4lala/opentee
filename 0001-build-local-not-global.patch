From ce560cdc081f873d2a53517f576e24af2ca9c6a0 Mon Sep 17 00:00:00 2001
From: code4lala <fenglala@outlook.com>
Date: Thu, 22 Jun 2023 11:09:03 +0800
Subject: [PATCH] build local, not global

Change-Id: Id7d035131edede3520f58edbefced7f5a29e27ab
---
 autogen.sh |  2 +-
 build.sh   | 44 ++++++++++++++++++++++++++++++++++++++++++++
 2 files changed, 45 insertions(+), 1 deletion(-)
 create mode 100755 build.sh

diff --git a/autogen.sh b/autogen.sh
index f3c8d82..f22f48e 100755
--- a/autogen.sh
+++ b/autogen.sh
@@ -7,4 +7,4 @@ mkdir -p ./{,emulator,libtee,libtee_pkcs11,libomnishare,tests,CAs,TAs}/m4
 autoreconf --install --symlink
 popd > /dev/null
 
-"$basedir"/configure --prefix="/opt/OpenTee" $@
+"$basedir"/configure $@
diff --git a/build.sh b/build.sh
new file mode 100755
index 0000000..019ace9
--- /dev/null
+++ b/build.sh
@@ -0,0 +1,44 @@
+set -evx
+
+MBEDTLS_BUILD_DIR=$(readlink -f ../mbedtls-3.1.0/build/)
+
+export CFLAGS=-I$MBEDTLS_BUILD_DIR/include
+export LDFLAGS=-L$MBEDTLS_BUILD_DIR/library
+
+OPENTEE_INSTALL_DIR=$(readlink -f ../install)
+
+rm -rf ./build
+mkdir ./build
+pushd ./build
+    ../autogen.sh --prefix=$OPENTEE_INSTALL_DIR
+    make -j64
+
+    rm -rf $OPENTEE_INSTALL_DIR
+    mkdir $OPENTEE_INSTALL_DIR
+    make install
+
+    mkdir $OPENTEE_INSTALL_DIR/etc
+    cat > $OPENTEE_INSTALL_DIR/etc/opentee.conf << EOF
+[PATHS]
+ta_dir_path = $OPENTEE_INSTALL_DIR/lib/TAs
+core_lib_path = $OPENTEE_INSTALL_DIR/lib
+subprocess_manager = libManagerApi.so
+subprocess_launcher = libLauncherApi.so
+EOF
+    cat << EOF
+usage: launch tee daemon first, then run test.
+tee daemon help:
+$OPENTEE_INSTALL_DIR/bin/opentee-engine --help
+launch tee daemon cmd:
+LD_LIBRARY_PATH=$MBEDTLS_BUILD_DIR/library $OPENTEE_INSTALL_DIR/bin/opentee-engine -c $OPENTEE_INSTALL_DIR/etc/opentee.conf
+check background tee daemon cmd:
+ps aux | grep -i tee
+kill background tee daemon cmd:
+ps aux | grep -i tee | awk {'print$2'} | xargs kill -9
+run test cmd:
+$OPENTEE_INSTALL_DIR/bin/conn_test
+check ta log cmd:
+tail -f /var/log/syslog
+EOF
+
+popd
-- 
2.34.1

